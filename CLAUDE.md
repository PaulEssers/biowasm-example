# CLAUDE.md â€” wasm-example

## What this project is

A sandbox for converting bioinformatics CLI tools to WebAssembly and running them in the browser. The current tool (`gc_calculator`) is a Rust toy example; the eventual real tools will be C/C++ programs compiled with Emscripten.

## Key architectural decision: wasm-pack vs aioli

- **Rust tools** use `wasm-pack` (`wasm-bindgen`, target `wasm32-unknown-unknown`). They export typed JS functions via ES modules. The browser calls them directly.
- **C/C++ tools** (future) will use [aioli from biowasm](https://biowasm.com/documentation/). Aioli wraps Emscripten-compiled CLI binaries and provides a shared virtual filesystem. It is *not* compatible with wasm-pack output.

Do not try to load a wasm-pack tool through aioli, or vice versa.

## Project structure

```
tools/                  # one directory per tool, each self-contained
  gc_calculator/
    Cargo.toml          # owns its own build config
    src/lib.rs          # source + unit tests
    pkg/                # wasm-pack output (gitignored, generated at build time)
web/                    # single frontend, imports from tools/*/pkg/
  index.html
  favicon.svg           # hand-drawn DNA helix icon
  main.ts               # TypeScript source; compiled to main.js by tsc
  main.js               # (gitignored, generated by tsc)
test-data/              # shared test fixtures
tsconfig.json           # TypeScript config (ES2020 modules, bundler resolution)
package.json            # npm dev server + typescript
Makefile                # make test-gc-calculator | make run
```

When adding a new Rust tool: create `tools/<name>/`, add a `Cargo.toml` with `crate-type = ["cdylib"]`, and wire it into `web/main.ts`. Nothing else in the repo needs to change.

## Build & run

```sh
make test-gc-calculator   # cargo test, no wasm build required
make run                  # wasm-pack build + tsc + dev server (port 8080)
```

The dev server (`serve`) must run from the **project root** so that both `web/` and `tools/*/pkg/` are reachable. The page is at `http://localhost:8080/web/`.

## Devcontainer

Image: `mcr.microsoft.com/devcontainers/rust:stable` + `wasm-pack` + Node 20 (via devcontainer feature). `postCreateCommand` runs `npm install`. Everything needed is in the container; nothing needs to be installed on the host.

## Conventions

- Tools serialize results to JSON from Rust (`serde_json`), JS parses with `JSON.parse()`. This keeps the Rust side language-agnostic and avoids the complexity of custom JsValue types.
- `Deserialize` is derived on result structs so unit tests can round-trip through JSON without a second struct.
- `pkg/` and `target/` inside each tool are gitignored via the root `.gitignore` globs (`tools/*/pkg/`, `tools/*/target/`).
- Escape all user-facing strings in the HTML via DOM text-node insertion (see `escapeHtml` in `main.ts`).
- The frontend is TypeScript. `wasm-pack` emits `.d.ts` declarations alongside the `.js` glue; `tsc` picks them up automatically via `bundler` module resolution. `web/main.js` is generated output (gitignored); the source is `web/main.ts`.
